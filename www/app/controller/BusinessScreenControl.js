/*
 * File: app/controller/BusinessScreenControl.js
 *
 * This file was generated by Sencha Architect version 2.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Sencha Touch 2.1.x library, under independent license.
 * License of Sencha Architect does not include license for Sencha Touch 2.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('MyApp.controller.BusinessScreenControl', {
    extend: 'Ext.app.Controller',

    config: {
        views: [
            'BusinessScreen'
        ],

        refs: {
            BusinessScreen: {
                selector: '#BusinessScreen',
                xtype: 'Ext.Panel'
            },
            goingbutton: {
                selector: '#goingbutton',
                xtype: 'Ext.Button'
            },
            ratebtn: {
                selector: '#ratebtn',
                xtype: 'Ext.Button'
            },
            RatingUserList: {
                selector: '#RatingUserList',
                xtype: 'list'
            },
            showphone: {
                selector: '#showphone',
                xtype: 'Ext.Button'
            },
            websiteTitle: {
                selector: '#websiteTitle',
                xtype: 'Ext.Label'
            }
        },

        control: {
            "BusinessScreen": {
                show: 'onBusinessPanelShow'
            },
            "goingbutton": {
                tap: 'ongoingbtnTap'
            },
            "label": {
                tap: 'onwebsiteTitleTap'
            },
            "ratebtn": {
                tap: 'onratebtnTap'
            },
            "RatingUserList": {
                initialize: 'onRatingUserListInitialize'
            },
            "showphone": {
                tap: 'onshowphoneTap'
            }
        }
    },

    onBusinessPanelShow: function(component, eOpts) {
        console.log('onBusinessPanelInitialize');

        this.ReloadBusinessData();
    },

    ongoingbtnTap: function(button, e, eOpts) {
        console.log('ongoingbtnTap');
        var BusinessID = Ext.ComponentQuery.query('#BusinessScreen')[0].business_id;

        if(BusinessID){
            //load main business data
            var GeneralActionStore = Ext.getStore('GeneralActionStore');
            var url = 'http://'+localStorage.serverpath+'/Server-side/BusinessesGoing.php';
            var proxy= GeneralActionStore.getProxy();
            proxy.setUrl(url);
            proxy.setExtraParam('BusinessID', BusinessID );
            proxy.setExtraParam('user_id', localStorage.user_id );
            console.log(url);
            GeneralActionStore.load({callback: function(records, operation, success) {
                var count = GeneralActionStore.getCount();
                var data = GeneralActionStore.getRange();
                console.log('GeneralActionStore count : ' + count);
                console.log('GeneralActionStore data : ' + data);

                var ResultRecord = GeneralActionStore.getAt(0);
                var Result = ResultRecord.get('result');
                console.log('Result:'+Result);

                if(Result=='true')
                {
                    //TODO: increas the going label +1
                    goingCountlbl = button.up('container').down('container[id=goinglblcont]');
                    goingCount = parseInt(goingCountlbl.getHtml());
                    if(!goingCount)
                    goingCount=0;
                    goingCount = goingCount +1;
                    goingCountlbl.setHtml(goingCount);

                    button.setBaseCls('businessgoingbtn');
                    button.setDisabled(true);
                }
            }
        });

    }
    },

    onwebsiteTitleTap: function() {
        console.log('onhomepagebtnTap');
        var LocalStore = Ext.getStore('LocalStore'); // Shortcut
        var aRecord = LocalStore.getAt(0);
        var BusinessID = aRecord.get('SelectedBusinessID');

        var MethodName ='BusinessClickHomepage';

        //load main business data
        var GeneralActionStore = Ext.getStore('GeneralActionStore');
        var url = 'http://'+localStorage.serverpath+'/Server-side/BusinessesGeneralAPI.php';
        var proxy= GeneralActionStore.getProxy();
        proxy.setUrl(url);
        proxy.setExtraParam('BusinessID', BusinessID );
        proxy.setExtraParam('MethodName', 'BusinessClickHomepage' );
        GeneralActionStore.load({callback: function(records, operation, success) {
            //console.log('callback onhomepagebtnTap');
            var count = GeneralActionStore.getCount();
            var data = GeneralActionStore.getRange();
            console.log('GeneralActionStore count : ' + count);
            console.log('GeneralActionStore data : ' + data);

            var ResultRecord = GeneralActionStore.getAt(0);
            var Result = ResultRecord.get('result');
            console.log('Result:'+Result);

            //read the HOME PAGE URL
            var BusinessStore = Ext.getStore('BusinessStore');
            var BusinessRecord = BusinessStore.getAt(0);
            var HomePageURL = BusinessRecord.get('HomePageURL');
            console.log('HomePageURL:'+HomePageURL);

            //launch the browser with the HOME PAGE URL
            if(Ext.os.is.iOS || Ext.os.is.Android)
            {
                Ext.device.Device.openURL(HomePageURL);
            }
            else
            {
                window.open(HomePageURL);
            }
        }
    });
    },

    onratebtnTap: function(button, e, eOpts) {
        console.log('onratebtnTap');
        var ScreenSelector = '#RatePlaceScreen';
        var view='MyApp.view.RatePlaceScreen';
        var id='RatePlaceScreen';

        var BusinessID = Ext.ComponentQuery.query('#BusinessScreen')[0].business_id;

        button.setBaseCls('ratebuttonpressed');

        Screen = Ext.ComponentQuery.query(ScreenSelector);

        if(Screen.length===0)//not  exists yet
        {
            Screen = Ext.create(view, {
                id: id
            });

            Screen.business_id = BusinessID;

            Ext.Viewport.setActiveItem(Screen);
        }
        else
        {
            Screen[0].business_id = BusinessID;
            Ext.Viewport.setActiveItem(Screen[0]);
        }
    },

    onRatingUserListInitialize: function(component, eOpts) {
        console.log('onRatingUserListInitialize');

        var LocalStore = Ext.getStore('LocalStore'); // Shortcut
        var aRecord = LocalStore.getAt(0);
        var BusinessID = aRecord.get('SelectedBusinessID');

        //var list = this.getRatingUserList();
        var list = component;
        var url = 'http://'+localStorage.serverpath+'/Server-side/GetBusinessUsers.php?id='+BusinessID;
        console.log(url);
        list.getStore().getProxy().setUrl(url);
        list.getStore().load({callback: function(records, operation, success) {
            list.setMasked(false);
            console.log('MASK IS REMOVED!!');
            var count = list.getStore().getCount();
            var data = list.getStore().getRange();
            console.log('RatingUserList count : ' + count);
            console.log('RatingUserList data : ' + data);
            list.refresh();
            //list.show();
        }
    });
    },

    onshowphoneTap: function(button, e, eOpts) {
        //change the phone label
        //showphone
        var BusinessStore = Ext.getStore('BusinessStoreBusinessScreen');
        var BusinessRecord = BusinessStore.getAt(0);
        button.setText(BusinessRecord.get('business_phone'));


        //use the gegenral API to update the counter
        var GeneralActionStore = Ext.getStore('GeneralActionStore');
        var url = 'http://'+localStorage.serverpath+'/Server-side/BusinessesGeneralAPI.php';
        var proxy= GeneralActionStore.getProxy();
        proxy.setUrl(url);
        proxy.setExtraParam('BusinessID', BusinessRecord.get('business_id') );
        proxy.setExtraParam('MethodName', 'BusinessPhoneClickCount' );
        GeneralActionStore.load({callback: function(records, operation, success) {
            //console.log('callback onhomepagebtnTap');
            console.log('BusinessPhoneClickCount done');

            var ResultRecord = GeneralActionStore.getAt(0);
            var Result = ResultRecord.get('result');
            console.log('Result:'+Result);
        }
    });
    },

    InitializeControls: function(callback) {
        console.log('InitializeControls');
        //set the value of the going button

        var BusinessStore = Ext.getStore('BusinessStoreBusinessScreen');
        var BusinessRecord = BusinessStore.getAt(0);

        //Going label
        //calculate the last update minutes
        var LastGoingClickTime = BusinessRecord.get('lastgoingclicktime');
        //console.log("LastRatingTime:"+LastRatingTime);
        var diff=-1;//the time diff between now and the last update time by user
        var now = new Date(); // now
        if(LastGoingClickTime)
        {                       
            //calculate the diff in minutes since last update
            diff= now - LastGoingClickTime;
            var sign=diff<0?-1:1;
            diff/=sign; // or diff=Math.abs(diff);
            var minutes,milliseconds,seconds;
            diff=(diff-(milliseconds=diff%1000))/1000;
            //diff=(diff-(seconds=diff%60))/60;
            diff=((diff-(minutes=diff%60))/60);
        }
        else
        {
            diff=-1;//dummy value	
        }
        goingCountlbl = Ext.ComponentQuery.query('#goinglblcont')[0];
        button = Ext.ComponentQuery.query('#goingbutton')[0];
        var GoingCounter = BusinessRecord.get('goingcounter');
        goingCountlbl.setHtml(GoingCounter);

        if(diff>1440 || diff ===-1)// if not clicked over the 24 hours, enable
        {
            button.setDisabled(false);
            Ext.ComponentQuery.query('#goingbutton')[0].setBaseCls('businessgoingbtnactive');
        }
        else
        {
            button.setDisabled(true); 	
            Ext.ComponentQuery.query('#goingbutton')[0].setBaseCls('businessgoingbtn');
        }


        //business name header
        businessnamelbl = Ext.ComponentQuery.query('#businessnamelbl')[0];
        businessname = BusinessRecord.get('business_name');
        businessnamelbl.setHtml(businessname);

        //image
        Ext.ComponentQuery.query('#businessImage')[0].setSrc(BusinessRecord.get('logourl'));
        //line lenght

        //business details

        var capacitypercent = 0;
        if(BusinessRecord.get('capacitypercent'))
        capacitypercent= BusinessRecord.get('capacitypercent');
        var moreboys =0;
        if(BusinessRecord.get('moreboys'))
        moreboys= BusinessRecord.get('moreboys');
        var moregirls=0;
        if(BusinessRecord.get('moregirls'))
        moregirls= BusinessRecord.get('moregirls');
        var linelenght=0;
        if(BusinessRecord.get('linelenght'))
        linelenght= BusinessRecord.get('linelenght');
        var likescounter = "";
        if(BusinessRecord.get('likescounter'))
        likescounter= "";//BusinessRecord.get('likescounter');


        //line length: 103 min <br> 10.975 km <br> 48% full <br> +23
        var distance = Ext.ComponentQuery.query('#BusinessScreen')[0].distance;
        Ext.ComponentQuery.query('#businessTitle')[0].setHtml('Line Length:'+linelenght+' min <br>'+distance+' km <br> '+capacitypercent+'% full <br> +'+BusinessRecord.get('minage')+'');




        //like counter
        //78 <br> 51% <br> 49%
        Ext.ComponentQuery.query('#businesslikeComp')[0].setHtml(''+likescounter+'<br> '+moregirls+'%'+'<br> '+moreboys+'%');

        //calculate the last update minutes
        var LastupdateTime = BusinessRecord.get('last_update_time');
        //console.log("LastRatingTime:"+LastRatingTime);
        diff=-1;//the time diff between now and the last update time by user
        now = new Date(); // now
        if(LastupdateTime)
        {                       
            //calculate the diff in minutes since last update
            diff= now - LastupdateTime;
            var sign=diff<0?-1:1;
            diff/=sign; // or diff=Math.abs(diff);
            var minutes,milliseconds,seconds;
            diff=(diff-(milliseconds=diff%1000))/1000;
            //diff=(diff-(seconds=diff%60))/60;
            diff=((diff-(minutes=diff%60))/60);
        }
        else
        {
            diff=-1;//dummy value	
        }

        //last update time lbl
        if(diff===-1)
        {
            Ext.ComponentQuery.query('#bslastupdatelbl')[0].setHtml('Last Updated:');
        }
        else
        {

            Ext.ComponentQuery.query('#bslastupdatelbl')[0].setHtml('Last Updated:<b>'+diff+' minutes ago</b>');
        }

        if(diff<5 && diff>=0)
        {
            Ext.ComponentQuery.query('#dotcontainerbusiness')[0].setHtml('<img src="resources/images/green_b.png" height="8" width="8")>');
        }
        else
        {
            Ext.ComponentQuery.query('#dotcontainerbusiness')[0].setHtml('<img src="resources/images/greydot.png" height="8" width="8")>');
        }


        //websiteTitle
        //launch the browser with the HOME PAGE URL
        var homepageurl = BusinessRecord.get('homepageurl');
        if(homepageurl===null || homepageurl ==="")//do not add the URL link
        {

            Ext.ComponentQuery.query('#websiteTitle')[0].setHtml('Website:');
        }
        else
        {

            if(Ext.os.is.iOS || Ext.os.is.Android)
            {
                //Ext.ComponentQuery.query('#websiteTitle')[0].setHtml('Website:'+BusinessRecord.get('business_name')+' <img src="resources/images/link.png" height="14" width="14" onclick=Ext.device.Device.openURL("'+BusinessRecord.get('homepageurl')+'")>');
                Ext.ComponentQuery.query('#websiteTitle')[0].setHtml('Website:<a href="'+BusinessRecord.get('homepageurl')+'">'+BusinessRecord.get('business_name')+'</a> <img src="resources/images/link.png" height="14" width="14" onclick=Ext.device.Device.openURL("'+homepageurl+'")>');
            }
            else
            {
                //Ext.ComponentQuery.query('#websiteTitle')[0].setHtml('Website:'+BusinessRecord.get('business_name')+' <img src="resources/images/link.png" height="14" width="14" onclick=window.open("'+BusinessRecord.get('homepageurl')+'")>');
                Ext.ComponentQuery.query('#websiteTitle')[0].setHtml('Website:<a href="'+BusinessRecord.get('homepageurl')+'">'+BusinessRecord.get('business_name')+'</a> <img src="resources/images/link.png" height="14" width="14" onclick=window.open("'+homepageurl+'")>');
            }
        }
        //businessemail
        Ext.ComponentQuery.query('#businessemail')[0].setHtml('Email:'+BusinessRecord.get('email'));

        //businessaddress
        Ext.ComponentQuery.query('#businessaddress')[0].setHtml('Address:'+BusinessRecord.get('full_address'));

        //waze
        Ext.ComponentQuery.query('#waze')[0].setHtml('Navigate with WAZE <img src="resources/images/link.png" height="14" width="14">');

        //businesstodaystyle
        Ext.ComponentQuery.query('#businesstodaystyle')[0].setHtml('Hot Day: '+BusinessRecord.get('todaystyle'));

        //businesstodaydeals
        Ext.ComponentQuery.query('#businesstodaydeals')[0].setHtml('Our Deals: '+BusinessRecord.get('today_deals'));

        //businessopenclosed
        Ext.ComponentQuery.query('#businessopenclosed')[0].setHtml('Open/Closed: '+BusinessRecord.get('businesshours'));


        //businesssummary
        Ext.ComponentQuery.query('#businesssummary')[0].setHtml(BusinessRecord.get('businesssummary'));                                            

        //TODO: set the Rating button
        var LastRatingTime = BusinessRecord.get('lastratingtime');
        //console.log("LastRatingTime:"+LastRatingTime);
        var diff;//the time diff between now and the last rating time by user
        var now = new Date(); // now
        if(LastRatingTime)
        {                       
            //calculate the diff in minutes since last rating
            diff= now - LastRatingTime;
            var sign=diff<0?-1:1;
            diff/=sign; // or diff=Math.abs(diff);
            var minutes,milliseconds,seconds;
            diff=(diff-(milliseconds=diff%1000))/1000;
            //diff=(diff-(seconds=diff%60))/60;
            diff=((diff-(minutes=diff%60))/60);
        }
        else
        {
            diff=0;//dummy value	
        }


        //var timediff = parseInt((now - LastRatingTime)/60); 
        var distanceMetter = (distance*1000);
        console.log("time diff:"+diff+", LastRatingTime:"+LastRatingTime+", now:"+now+",  distanceMetter:"+distanceMetter);
        //activate the button
        if(diff>15 && distanceMetter<=25 )
        {
            console.log("ratebtn enabled");
            Ext.ComponentQuery.query('#ratebtn')[0].setBaseCls('ratebutton');
            Ext.ComponentQuery.query('#ratebtn')[0].setDisabled(false);
        }
        else
        {
            console.log("ratebtn disabled");
            Ext.ComponentQuery.query('#ratebtn')[0].setBaseCls('ratebuttonpressed');
            Ext.ComponentQuery.query('#ratebtn')[0].setDisabled(true);
        }

        //business_phone
        Ext.ComponentQuery.query('#showphone')[0].setText('Show phone number');

        callback();
    },

    InitializePhotos: function(callback) {
        console.log('InitializePhotos');

        var carousel = Ext.ComponentQuery.query('#photocarousel')[0];
        //remove all current items from the carousel
        carousel.removeAll(true,true);

        //loop over the BusinessPhotosStore and add items to the carousel
        var BusinessPhotosStore = Ext.getStore('BusinessPhotosStore');
        BusinessPhotosStore.each(function(record){

            /* var img = Ext.create('image',{
            xtype: 'image',
            src:record.get('PhotoURL'),
            cls:'businessphoto'
            });*/

            //Ext.onReady(function(){
            carousel.add({
                html: '<img src="' + record.get('photourl') + '" height="140" width="140">'
            });
            // });

            //carousel.add(img);
        });

        carousel.next();

        callback();
    },

    ReloadBusinessData: function() {
        console.log('ReloadBusinessData');

        /*var LocalStore = Ext.getStore('LocalStore'); // Shortcut
        var aRecord = LocalStore.getAt(0);
        var BusinessID = aRecord.get('SelectedBusinessID');*/
        var BusinessID = Ext.ComponentQuery.query('#BusinessScreen')[0].business_id;
        console.log('Selected business ID is: ' + BusinessID);


        //load main business data
        var BusinessStore = Ext.getStore('BusinessStoreBusinessScreen');
        BusinessStore.removeAll(true);

        /*var UserStore = Ext.getStore('UserStore');
        var aRecord = UserStore.getAt(0);
        var user_id = aRecord.get('user_id');*/

        //BusinessStore.sync();
        var url = 'http://'+localStorage.serverpath+'/Server-side/GetBusinessesByParams.php';
        //var url = 'http://localhost/elitest_sencha_phonegap%20-%20biluim%202/elitest_sencha_phonegap/android/assets/www/Server-side/GetBusinessesByParams.php?id=5&filtered=2&sortingBy=id';
        console.log(url);
        var proxy= BusinessStore.getProxy();
        proxy.setUrl(url);
        proxy.setExtraParam('id', BusinessID );
        proxy.setExtraParam('filtered', "2" );//business screen filter
        proxy.setExtraParam('sortingBy', "id" );
        proxy.setExtraParam('user_id', localStorage.user_id );
        BusinessStore.load({callback: function(records, operation, success) {
            var count = BusinessStore.getCount();
            var data = BusinessStore.getRange();
            console.log('BusinessStore count : ' + count);
            console.log('BusinessStore data : ' + data);

            var controller = MyApp.app.getController( 'MyApp.controller.BusinessScreenControl');
            controller.InitializeControls(function(){
                //locad photos
                var BusinessPhotosStore = Ext.getStore('BusinessPhotosStore');
                var proxy1= BusinessPhotosStore.getProxy();
                url = 'http://'+localStorage.serverpath+'/Server-side/GetBusinessPhotos.php';
                proxy1.setUrl(url);
                proxy1.setExtraParam('id', BusinessID );
                console.log(url);
                BusinessPhotosStore.load({callback: function(records, operation, success) {
                    var count = BusinessPhotosStore.getCount();
                    var data = BusinessPhotosStore.getRange();
                    console.log('BusinessPhotosStore count : ' + count);
                    console.log('BusinessPhotosStore data : ' + data);

                    //set the photos
                    controller.InitializePhotos();
                }
            });  
        });

    }
            });

    }

});